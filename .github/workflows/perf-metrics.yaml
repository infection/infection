# yamllint disable rule:line-length
# yamllint disable rule:braces

name: Performance Metrics

on:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/perf-metrics.yaml'
      - 'src/**'
      - 'bin/**'
      - 'composer.*'
  pull_request:
    paths:
      - '.github/workflows/perf-metrics.yaml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (tag, commit, or branch) to test'
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  METRICS_COMMIT_PREFIX: "perf: Add metrics for"

jobs:
  check:
    name: Check if should run
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG="$(git log -1 --format='%s')"
          if [[ "$COMMIT_MSG" == "$METRICS_COMMIT_PREFIX"* ]]; then
            echo "Skipping - triggered by metrics commit: $COMMIT_MSG"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

  collect:
    needs: check
    if: needs.check.outputs.skip != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    name: Collect performance metrics

    outputs:
      entry_json: ${{ steps.prepare.outputs.entry_json }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # When ref input is provided, checkout from upstream (where tags exist)
          repository: ${{ github.event.inputs.ref && 'infection/infection' || github.repository }}
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: pcov
          tools: composer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: composer-${{ runner.os }}-8.2-${{ hashFiles('composer.*') }}
          restore-keys: |
            composer-${{ runner.os }}-8.2-
            composer-${{ runner.os }}-
            composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Collect coverage report
        run: |
          php vendor/phpunit/phpunit/phpunit --stop-on-failure \
            --coverage-xml=var/logs/coverage-xml \
            --log-junit=var/logs/junit.xml

      - name: Collect runner specs
        id: runner-specs
        run: |
          echo "cpu_model=$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)" >> $GITHUB_OUTPUT
          echo "cpu_cores=$(nproc)" >> $GITHUB_OUTPUT
          echo "cpu_arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "total_memory_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Run Infection with timing
        run: |
          /usr/bin/time -f '{"user_time_sec":%U,"system_time_sec":%S,"wall_clock_sec":%e,"max_rss_kb":%M,"cpu_percent":"%P","voluntary_ctx_switches":%w,"involuntary_ctx_switches":%c,"exit_status":%x}' \
            -o timing.json \
            php bin/infection \
              --skip-initial-tests \
              --coverage=var/logs \
              --no-progress \
              --threads=max \
              --no-interaction \
              --logger-summary-json=infection-summary.json \
            || true
          cat timing.json

      - name: Prepare metrics entry
        id: prepare
        run: |
          # Create the metrics preparation script inline (so it works for old tags too)
          cat > prepare-metrics.php << 'SCRIPT_EOF'
          <?php
          $content = file_get_contents($argv[1]);
          // When command exits non-zero, time prepends "Command exited with non-zero status N\n"
          if (str_starts_with($content, 'Command exited')) {
              $content = substr($content, strpos($content, "\n") + 1);
          }
          $timing = json_decode($content, true);
          if ($timing === null) {
              fwrite(STDERR, "Failed to parse timing.json: " . json_last_error_msg() . "\n");
              fwrite(STDERR, "Content: $content\n");
              exit(1);
          }

          $mutations = null;
          if (file_exists('infection-summary.json')) {
              $summary = json_decode(file_get_contents('infection-summary.json'), true);
              if ($summary !== null && isset($summary['stats'])) {
                  $mutations = [
                      'total' => $summary['stats']['totalMutantsCount'] ?? 0,
                      'killed' => $summary['stats']['killedCount'] ?? 0,
                      'msi' => $summary['stats']['msi'] ?? 0,
                  ];
              }
          }

          $cpuCores = (int) getenv('CPU_CORES') ?: 1;
          $wallClock = (float) ($timing['wall_clock_sec'] ?? 0);
          $userTime = (float) ($timing['user_time_sec'] ?? 0);
          $sysTime = (float) ($timing['system_time_sec'] ?? 0);
          $maxRss = (int) ($timing['max_rss_kb'] ?? 0);

          $wallPerCore = $cpuCores > 0 ? round($wallClock / $cpuCores, 2) : 0;
          $cpuTotal = round($userTime + $sysTime, 2);
          $wallPerMut = $userPerMut = $memPerMut = 0;

          if ($mutations !== null && $mutations['total'] > 0) {
              $wallPerMut = round($wallClock / $mutations['total'], 4);
              $userPerMut = round($userTime / $mutations['total'], 4);
              $memPerMut = round($maxRss / $mutations['total'], 2);
          }

          $entry = array_merge($timing, [
              'timestamp' => gmdate('Y-m-d\TH:i:s\Z'),
              'commit_date' => getenv('COMMIT_DATE'),
              'git_sha' => getenv('GIT_SHA'),
              'git_ref' => getenv('GIT_REF'),
              'trigger' => getenv('TRIGGER'),
              'php_version' => PHP_VERSION,
              'config' => ['name' => 'baseline', 'args' => '--no-progress --threads=max'],
              'runner' => [
                  'os' => 'ubuntu-latest',
                  'image_version' => getenv('IMAGE_VERSION') ?: 'unknown',
                  'cpu_model' => getenv('CPU_MODEL'),
                  'cpu_cores' => $cpuCores,
                  'cpu_arch' => getenv('CPU_ARCH'),
                  'total_memory_kb' => (int) getenv('TOTAL_MEM'),
              ],
          ]);

          if ($mutations !== null) {
              $entry['mutations'] = $mutations;
          }

          $entry['derived'] = [
              'wall_clock_per_core' => $wallPerCore,
              'cpu_time_total' => $cpuTotal,
              'wall_clock_per_mutation' => $wallPerMut,
              'user_time_per_mutation' => $userPerMut,
              'memory_per_mutation_kb' => $memPerMut,
          ];

          echo json_encode($entry, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n";
          SCRIPT_EOF

          # Set environment variables for the PHP script
          export CPU_CORES=${{ steps.runner-specs.outputs.cpu_cores }}
          export COMMIT_DATE=$(git log -1 --format='%cI')
          export GIT_SHA=$(git rev-parse HEAD)
          export GIT_REF="${{ github.event.inputs.ref || github.ref }}"
          export TRIGGER="${{ github.event_name }}"
          export CPU_MODEL="${{ steps.runner-specs.outputs.cpu_model }}"
          export CPU_ARCH="${{ steps.runner-specs.outputs.cpu_arch }}"
          export TOTAL_MEM=${{ steps.runner-specs.outputs.total_memory_kb }}
          export IMAGE_VERSION="${ImageVersion:-unknown}"

          # Run the script
          php prepare-metrics.php timing.json > entry.json

          echo "Final metrics entry:"
          cat entry.json

          # Compact to single line for JSONL
          echo "entry_json=$(jq -c . entry.json)" >> $GITHUB_OUTPUT

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-entry
          path: entry.json

  commit:
    needs: [check, collect]
    runs-on: ubuntu-latest
    # Only commit if not skipped and collect succeeded
    if: |
      needs.check.outputs.skip != 'true' &&
      needs.collect.result == 'success' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout metrics repository
        uses: actions/checkout@v4
        with:
          repository: infection/infection-metrics
          ssh-key: ${{ secrets.INFECTION_METRICS_SSHKEY }}
          path: metrics-repo

      - name: Configure git
        run: |
          cd metrics-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download metrics artifact
        uses: actions/download-artifact@v4
        with:
          name: metrics-entry
          path: artifacts

      - name: Append metrics to JSONL
        run: |
          cd metrics-repo

          # Append new entry as single line
          jq -c . ../artifacts/entry.json >> metrics.jsonl

          echo "Updated metrics.jsonl:"
          tail -5 metrics.jsonl

      - name: Commit and push
        run: |
          cd metrics-repo
          git add metrics.jsonl
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          # Build commit message with tag (if provided) and short SHA
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          REF_INPUT="${{ github.event.inputs.ref }}"
          if [[ -n "$REF_INPUT" ]]; then
            COMMIT_MSG="$METRICS_COMMIT_PREFIX $REF_INPUT ($SHORT_SHA)"
          else
            COMMIT_MSG="$METRICS_COMMIT_PREFIX $SHORT_SHA"
          fi

          git commit -m "$COMMIT_MSG"
          git push
