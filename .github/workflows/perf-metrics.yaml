# yamllint disable rule:line-length
# yamllint disable rule:braces

name: Performance Metrics

on:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/perf-metrics.yaml'
      - 'src/**'
      - 'bin/**'
      - 'composer.*'
  pull_request:
    paths:
      - '.github/workflows/perf-metrics.yaml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (tag, commit, or branch) to test'
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  METRICS_COMMIT_PREFIX: "perf: Add metrics for"

jobs:
  check:
    name: Check if should run
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG="$(git log -1 --format='%s')"
          if [[ "$COMMIT_MSG" == "$METRICS_COMMIT_PREFIX"* ]]; then
            echo "Skipping - triggered by metrics commit: $COMMIT_MSG"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

  collect:
    needs: check
    if: needs.check.outputs.skip != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    name: Collect performance metrics

    outputs:
      entry_json: ${{ steps.prepare.outputs.entry_json }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # When ref input is provided, checkout from upstream (where tags exist)
          repository: ${{ github.event.inputs.ref && 'infection/infection' || github.repository }}
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: pcov
          tools: composer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: composer-${{ runner.os }}-8.2-${{ hashFiles('composer.*') }}
          restore-keys: |
            composer-${{ runner.os }}-8.2-
            composer-${{ runner.os }}-
            composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Collect coverage report
        run: |
          php vendor/phpunit/phpunit/phpunit --stop-on-failure \
            --coverage-xml=var/logs/coverage-xml \
            --log-junit=var/logs/junit.xml

      - name: Collect runner specs
        id: runner-specs
        run: |
          echo "cpu_model=$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)" >> $GITHUB_OUTPUT
          echo "cpu_cores=$(nproc)" >> $GITHUB_OUTPUT
          echo "cpu_arch=$(uname -m)" >> $GITHUB_OUTPUT
          echo "total_memory_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Run Infection with timing
        run: |
          /usr/bin/time -f '{"user_time_sec":%U,"system_time_sec":%S,"wall_clock_sec":%e,"max_rss_kb":%M,"cpu_percent":"%P","voluntary_ctx_switches":%w,"involuntary_ctx_switches":%c,"exit_status":%x}' \
            -o timing.json \
            php bin/infection \
              --skip-initial-tests \
              --coverage=var/logs \
              --no-progress \
              --threads=max \
              --no-interaction \
              --logger-summary-json=infection-summary.json \
            || true
          cat timing.json

      - name: Prepare metrics entry
        id: prepare
        run: |
          CPU_CORES=${{ steps.runner-specs.outputs.cpu_cores }}
          COMMIT_DATE=$(git log -1 --format='%cI')

          # Add metadata and runner specs to timing data
          # Use actual checked-out commit info (not workflow context) when ref input is provided
          ACTUAL_SHA=$(git rev-parse HEAD)
          ACTUAL_REF="${{ github.event.inputs.ref || github.ref }}"

          jq --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             --arg commit_date "$COMMIT_DATE" \
             --arg sha "$ACTUAL_SHA" \
             --arg ref "$ACTUAL_REF" \
             --arg trigger "${{ github.event_name }}" \
             --arg php_version "$(php -r 'echo PHP_VERSION;')" \
             --arg config_name "baseline" \
             --arg config_args "--no-progress --threads=max" \
             --arg os "ubuntu-latest" \
             --arg image "${ImageVersion:-unknown}" \
             --arg cpu_model "${{ steps.runner-specs.outputs.cpu_model }}" \
             --argjson cpu_cores "$CPU_CORES" \
             --arg cpu_arch "${{ steps.runner-specs.outputs.cpu_arch }}" \
             --argjson total_mem "${{ steps.runner-specs.outputs.total_memory_kb }}" \
             '. + {
               timestamp: $ts,
               commit_date: $commit_date,
               git_sha: $sha,
               git_ref: $ref,
               trigger: $trigger,
               php_version: $php_version,
               config: {
                 name: $config_name,
                 args: $config_args
               },
               runner: {
                 os: $os,
                 image_version: $image,
                 cpu_model: $cpu_model,
                 cpu_cores: $cpu_cores,
                 cpu_arch: $cpu_arch,
                 total_memory_kb: $total_mem
               }
             }' timing.json > with_meta.json

          # Extract mutation statistics from summary JSON
          if [[ -f infection-summary.json ]]; then
            MUTATIONS=$(jq '.stats.totalMutantsCount // 0' infection-summary.json)
            KILLED=$(jq '.stats.killedCount // 0' infection-summary.json)
            MSI=$(jq '.stats.msi // 0' infection-summary.json)
          else
            MUTATIONS=0
            KILLED=0
            MSI=0
          fi

          # Add mutations object to metrics
          jq --argjson mutations "$MUTATIONS" \
             --argjson killed "$KILLED" \
             --argjson msi "$MSI" \
             '. + {
               mutations: {
                 total: $mutations,
                 killed: $killed,
                 msi: $msi
               }
             }' with_meta.json > with_mutations.json

          # Compute derived metrics
          WALL_CLOCK=$(jq '.wall_clock_sec' with_mutations.json)
          USER_TIME=$(jq '.user_time_sec' with_mutations.json)
          SYS_TIME=$(jq '.system_time_sec' with_mutations.json)
          MAX_RSS=$(jq '.max_rss_kb' with_mutations.json)

          # Calculate normalized (per-mutation) metrics
          if [[ "$MUTATIONS" -gt 0 ]]; then
            WALL_PER_MUTATION=$(echo "scale=4; $WALL_CLOCK / $MUTATIONS" | bc)
            USER_PER_MUTATION=$(echo "scale=4; $USER_TIME / $MUTATIONS" | bc)
            MEM_PER_MUTATION=$(echo "scale=2; $MAX_RSS / $MUTATIONS" | bc)
          else
            WALL_PER_MUTATION=0
            USER_PER_MUTATION=0
            MEM_PER_MUTATION=0
          fi

          jq --argjson wall_per_core "$(echo "scale=2; $WALL_CLOCK / $CPU_CORES" | bc)" \
             --argjson cpu_total "$(echo "scale=2; $USER_TIME + $SYS_TIME" | bc)" \
             --argjson wall_per_mut "$WALL_PER_MUTATION" \
             --argjson user_per_mut "$USER_PER_MUTATION" \
             --argjson mem_per_mut "$MEM_PER_MUTATION" \
             '. + {
               derived: {
                 wall_clock_per_core: $wall_per_core,
                 cpu_time_total: $cpu_total,
                 wall_clock_per_mutation: $wall_per_mut,
                 user_time_per_mutation: $user_per_mut,
                 memory_per_mutation_kb: $mem_per_mut
               }
             }' with_mutations.json > entry.json

          echo "Final metrics entry:"
          cat entry.json | jq .

          # Compact to single line for JSONL
          echo "entry_json=$(jq -c . entry.json)" >> $GITHUB_OUTPUT

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-entry
          path: entry.json

  commit:
    needs: [check, collect]
    runs-on: ubuntu-latest
    # Only commit if not skipped and collect succeeded
    if: |
      needs.check.outputs.skip != 'true' &&
      needs.collect.result == 'success' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout metrics repository
        uses: actions/checkout@v4
        with:
          repository: infection/infection-metrics
          ssh-key: ${{ secrets.INFECTION_METRICS_SSHKEY }}
          path: metrics-repo

      - name: Configure git
        run: |
          cd metrics-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download metrics artifact
        uses: actions/download-artifact@v4
        with:
          name: metrics-entry
          path: artifacts

      - name: Append metrics to JSONL
        run: |
          cd metrics-repo

          # Append new entry as single line
          jq -c . ../artifacts/entry.json >> metrics.jsonl

          echo "Updated metrics.jsonl:"
          tail -5 metrics.jsonl

      - name: Commit and push
        run: |
          cd metrics-repo
          git add metrics.jsonl
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          # Build commit message with tag (if provided) and short SHA
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          REF_INPUT="${{ github.event.inputs.ref }}"
          if [[ -n "$REF_INPUT" ]]; then
            COMMIT_MSG="$METRICS_COMMIT_PREFIX $REF_INPUT ($SHORT_SHA)"
          else
            COMMIT_MSG="$METRICS_COMMIT_PREFIX $SHORT_SHA"
          fi

          git commit -m "$COMMIT_MSG"
          git push
